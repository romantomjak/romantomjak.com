<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Roman Tomjak">
    
    <meta name="generator" content="Hugo 0.73.0" />
    <title>Managing Docker Compose Secrets &middot; Notes on programming</title>
    
    <link rel="shortcut icon" href="https://romantomjak.com/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="https://romantomjak.com/images/apple-touch-icon.png">
    <link rel="stylesheet" href="https://romantomjak.com/css/style.css">
    <link rel="stylesheet" href="https://romantomjak.com/css/syntax/atom-one-dark.css">
    
</head>
<body>


<header class="header">
    <a href="/">
        <img class="header__gif--static hidden" src="https://romantomjak.com/images/mother-of-god.png"/>
        
        <img class="header__gif" src="https://romantomjak.com/images/mother-of-god.gif"/>
    </a>
    <h1 class="header__title">Notes on programming</h1>
    <nav class="hidden">
        <ul class="nav-primary">
            <li><a class="nav-primary__link" href="/">blog</a>/</li>
            <li><a class="nav-primary__link" href="/code">code</a>/</li>
            <li><a class="nav-primary__link" href="/about">me</a></li>
        </ul>
    </nav>
</header>


<main class="article">
    <h1 class="article__title">Managing Docker Compose Secrets</h1>
    <article class="article__content">
        <header class="article__header">
            <time datetime="2021-07-13T21:05:33.000&#43;01:00">July 13, 2021</time> &middot; 5 min read
        </header>
        <p>I use docker compose pretty much for everything. I remember at one point I even was maintaing a production application with docker compose. I would copy the <code>docker-compose.yml</code> file to the server and then start the containers manually.</p>
<p>I really liked how simple it was. There was nothing to maintain apart from the same docker compose file I used during development! Managing secrets was annoying though. Not impossible, but mighty annoying.</p>
<p>Over the years I&rsquo;ve tried multiple approaches - I&rsquo;ve tried creating <code>.env</code> file, I&rsquo;ve tried writing a shell script, I&rsquo;ve templated the <code>docker-compose.yml</code>, I&rsquo;ve even hard coded secrets in <code>docker-compose.yml</code> (don&rsquo;t do that). None of the approaches truly made me think &ldquo;yeah, this is nice&rdquo;. It was more like &ldquo;hope no one sees this xoxo&rdquo;.</p>
<h2 id="the-double-dash-mystery">The double dash mystery</h2>
<p>One day I was messing arround with SSH host autocomplete and I came accross the peculiar looking double dash (<code>--</code>) syntax:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">compgen -W <span style="color:#e6db74">&#34;</span>$WORD_LIST<span style="color:#e6db74">&#34;</span> -- <span style="color:#e6db74">${</span>CURRENT_WORD<span style="color:#e6db74">}</span>
</code></pre></div><p>Turns out the double dash is used by most shells as a delimiter indicating the end of the options after which only positional arguments are accepted.</p>
<p>That got me thinking. What if I could write a program that would read the secrets from <em>somewhere</em> and then expose them to docker compose as environment variables?</p>
<p>I&rsquo;ve played with this idea before with a shell script, but quickly abandoned it because the secrets still had to be stored <em>somewhere</em> safely. This time around I was inspired by <a href="https://docs.ansible.com/ansible/latest/cli/ansible-vault.html">ansible-vault</a>! I could store the secrets in an encrypted file right there along other files in the git repo!</p>
<h2 id="docker-compose-and-environment-variables">Docker compose and environment variables</h2>
<p>I already knew (*cough* from previous experience *cough*) that docker compose offers many ways to pass environment variables to containers. One approach immediately spring to mind - I could pass them through the <code>environment</code> key in the <code>docker-compose.yml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">environment</span>:
  - ENV=development
  - TAG=${GIT_COMMIT}
  - SECRET_KEY
</code></pre></div><p>Please note that last item in the array - the <code>SECRET_KEY</code>. Specifying only a key tells docker compose to resolve the environment variable on the machine on which the compose is running on. Yes! We&rsquo;re on to something here!</p>
<h2 id="vaults-for-storing-secrets">Vaults for storing secrets</h2>
<p>After a couple of days once I finally &ldquo;understood&rdquo; how to use cryptographic functions in Go, I&rsquo;ve managed to conjure <a href="https://github.com/romantomjak/env-vault">env-vault</a>! A convenient way to launch a program with environment variables populated from an encrypted file.</p>
<p>Once you&rsquo;ve got <code>env-vault</code> installed, you can create a Vault using the <code>create</code> sub-command. Let&rsquo;s create a vault named <code>prod.env</code> to hold our production secrets:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">env-vault create prod.env
</code></pre></div><p>Running the command above will prompt for a new password and then open your favorite <code>$EDITOR</code> to input the environment variables. Let&rsquo;s add the <code>SECRET_KEY</code> secret now:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">SECRET_KEY<span style="color:#f92672">=</span>somesecretformyproject
</code></pre></div><p>Save the file and close your editor. <code>env-vault</code> will encrypt the plain text using AES256-GCM symmetrical encryption. Vaults are safe to commit even on public repos, but like with everything else you must decide for yourself if you&rsquo;re willing to accept the risk.</p>
<h2 id="telling-docker-compose-about-the-secrets">Telling docker compose about the secrets</h2>
<p>Now that we have a Vault, let&rsquo;s see how we can use <code>env-vault</code> to decrypt secrets and expose them as environment variables to other programs. The general form for starting other programs looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">env-vault &lt;vault&gt; &lt;program&gt; -- &lt;program-arg1&gt; &lt;program-arg2&gt; &lt;...&gt;
</code></pre></div><p>The <code>&lt;program&gt;</code> argument is the executable that will be launched with environment variables from the encrypted file pointed to by <code>&lt;vault&gt;</code> argument. Everything after the double dashes (<code>--</code>) will be collected by <code>env-vault</code> and passed to the <code>&lt;program&gt;</code>.</p>
<p>Here is how we can use it to tell docker compose about the secrets:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">env-vault prod.env docker-compose -- up -d
</code></pre></div><p>It looks somewhat mad, but essentially <code>env-vault</code> will decrypt <code>prod.env</code> and expose found environment variables to docker compose. That&rsquo;s all you need to know to begin using <code>env-vault</code>!</p>
<h2 id="managing-vault-passwords">Managing Vault passwords</h2>
<p>You will need to develop a strategy for managing your vault passwords. Each time you decrypt a Vault, you must provide a password. You can use a single password for everything or you can use multiple passwords for different environments and projects. However, you will then need to keep track of your Vault passwords.</p>
<p>If you go down the route of using a one password for all your Vaults, you can set the <code>ENV_VAULT_PASSWORD</code> environment variable. When it is set, <code>env-vault</code> will use it to decrypt vaults automatically and you won&rsquo;t get prompted for a password any time you interact with a Vault. You can set it like so:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">export ENV_VAULT_PASSWORD<span style="color:#f92672">=</span>somepassword
</code></pre></div><h2 id="adding-a-makefile-to-speed-things-up">Adding a Makefile to speed things up</h2>
<p>Makefiles are at the center of all my workflows and it is how I interact with docker compose and various other tools. If you&rsquo;ve set the <code>ENV_VAULT_PASSWORD</code> environment variable you will forget the <code>env-vault</code> is even there!</p>
<p>Here is an example Makefile target for decrypting secrets and starting containers:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">up</span><span style="color:#f92672">:</span> <span style="color:#75715e">## Start all containers in detached mode
</span><span style="color:#75715e"></span>	env-vault prod.env docker-compose -- -f docker-compose.yml up -d
</code></pre></div><p>so now you can run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">make up
</code></pre></div><p>and <code>env-vault</code> will take it from there. Yeah, this is nice.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Simplicity is paramount when I&rsquo;m not working on a project all the time, but only every now and then (*cough* like with all of my side projects *cough*). The less there is to remember the faster I can jump right back into it!</p>
<p>Security is important, but so is simplicity. <a href="https://github.com/romantomjak/env-vault">env-vault</a> reduces the risk of unintentionally commiting secrets to a public repo and offers a convenient way to manage them.</p>

    </article>
</main>

<footer class="footer">
    <nav>
        <ul class="nav-secondary">
            <li>
                <a href="https://github.com/romantomjak">
                    <img class="nav-secondary__icon" src="https://romantomjak.com/images/github.svg" alt="Github" />
                </a>
            </li>
            <li>
                <a href="https://twitter.com/romantomjak">
                    <img class="nav-secondary__icon" src="https://romantomjak.com/images/twitter.svg" alt="Twitter" />
                </a>
            </li>
            <li>
                <a href="https://www.linkedin.com/in/romanstomjaks">
                    <img class="nav-secondary__icon" src="https://romantomjak.com/images/linkedin.svg" alt="LinkedIn" />
                </a>
            </li>
        </ul>
    </nav>
    <p>Copyright &copy; 2018-2021 Roman Tomjak</p>
</footer>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-67617807-9"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-67617807-9');
</script>
<script src="https://romantomjak.com/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

